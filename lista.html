<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de la Compra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Efecto tachado al marcar el checkbox */
        input:checked + div label span.nombre-item {
            text-decoration: line-through;
            color: #9ca3af;
        }
        input:checked + div {
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-4xl mx-auto px-4 py-8 mt-20">
        
        <h1 class="text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3">
            ðŸ›’ Lista de la Compra Inteligente
        </h1>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
            <label class="block text-sm font-bold text-gray-700 mb-2">Â¿QuÃ© semana quieres comprar?</label>
            <div class="flex flex-col md:flex-row gap-4">
                <select id="selector-semana" class="flex-1 p-3 border rounded-xl bg-gray-50 text-lg outline-none focus:ring-2 focus:ring-blue-500">
                    </select>
                <button onclick="generarLista()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                    âœ¨ Generar Lista
                </button>
            </div>
        </div>

        <div id="contenedor-lista" class="hidden">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-700">Ingredientes necesarios:</h2>
                <div class="flex gap-2">
                    <button onclick="copiarTexto()" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition">ðŸ“‹ Copiar</button>
                    <button onclick="compartirWhatsapp()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">ðŸ’¬ WhatsApp</button>
                </div>
            </div>

            <div id="lista-items" class="bg-white rounded-2xl shadow-lg border border-slate-200 divide-y divide-gray-100 overflow-hidden">
                </div>
            
            <p class="text-xs text-gray-400 mt-4 text-center">
                Nota: El sistema suma cantidades si el nombre del ingrediente es idÃ©ntico.
            </p>
        </div>

    </div>

    <script src="navbar.js"></script>
    <script src="menus.js"></script>
    <script src="recetas.js"></script>

    <script>
        // 1. Cargar el selector de semanas al iniciar
        window.onload = function() {
            const selector = document.getElementById('selector-semana');
            if (typeof coleccionMenus !== 'undefined') {
                coleccionMenus.forEach((menu, index) => {
                    const opt = document.createElement('option');
                    opt.value = index; 
                    opt.text = menu.nombre;
                    selector.appendChild(opt);
                });
            }
        };

        // 2. FUNCIÃ“N PRINCIPAL: GENERAR LISTA
        function generarLista() {
            const indexSemana = document.getElementById('selector-semana').value;
            const menuSeleccionado = coleccionMenus[indexSemana];
            
            // ESTRUCTURA NUEVA: 
            // { "tomates": { cantidad: 6, fuentes: Set("Gazpacho", "Ensalada") } }
            const cestaCompra = {};
            const itemsSinReceta = new Set(); 

            // Recorremos los 7 dÃ­as
            menuSeleccionado.semana.forEach(dia => {
                ['segundoDesayuno', 'almuerzo', 'merienda', 'cena'].forEach(momento => {
                    const platos = dia.comidas[momento];
                    if (platos && Array.isArray(platos)) {
                        platos.forEach(nombrePlato => {
                            procesarPlato(nombrePlato, cestaCompra, itemsSinReceta);
                        });
                    }
                });
            });

            renderizarLista(cestaCompra, itemsSinReceta);
        }

        function procesarPlato(nombrePlato, cesta, listaExtra) {
            const receta = listaRecetas.find(r => r.titulo.toLowerCase().trim() === nombrePlato.toLowerCase().trim());

            if (receta) {
                // Pasamos tambiÃ©n el tÃ­tulo de la receta para guardarlo
                receta.ingredientes.forEach(lineaIngrediente => {
                    parsearYSumar(lineaIngrediente, cesta, receta.titulo);
                });
            } else {
                listaExtra.add(`[Plato Completo] ${nombrePlato}`);
            }
        }

        function parsearYSumar(textoIngrediente, cesta, nombreReceta) {
            let texto = textoIngrediente.trim();
            const regex = /^([\d\.,\/]+)\s*(.*)/;
            const match = texto.match(regex);

            let nombreItem = "";
            let cantidadNum = 0;

            if (match) {
                let cantidad = match[1];
                nombreItem = match[2].toLowerCase(); 
                cantidadNum = convertirANumero(cantidad);
            } else {
                nombreItem = texto.toLowerCase();
            }

            // Normalizar nombres
            nombreItem = normalizarNombre(nombreItem);

            // Si el ingrediente no existe, lo creamos
            if (!cesta[nombreItem]) {
                cesta[nombreItem] = {
                    cantidad: 0,
                    fuentes: new Set() // Usamos un Set para no repetir nombres de recetas
                };
            }

            // Sumamos cantidad y aÃ±adimos la fuente (receta)
            cesta[nombreItem].cantidad += cantidadNum;
            cesta[nombreItem].fuentes.add(nombreReceta);
        }

        function convertirANumero(str) {
            str = str.replace(',', '.'); 
            if (str.includes('/')) {
                const partes = str.split('/');
                return parseFloat(partes[0]) / parseFloat(partes[1]);
            }
            return parseFloat(str);
        }

        function normalizarNombre(nombre) {
            nombre = nombre.replace(/^gramos\s/i, 'gr. ');
            nombre = nombre.replace(/^g\s/i, 'gr. ');
            nombre = nombre.replace(/^ml\s/i, 'ml. ');
            return nombre;
        }

        // 3. PINTAR RESULTADOS
        function renderizarLista(cesta, extras) {
            const contenedor = document.getElementById('lista-items');
            contenedor.innerHTML = "";
            document.getElementById('contenedor-lista').classList.remove('hidden');

            const itemsOrdenados = Object.keys(cesta).sort();

            itemsOrdenados.forEach((nombre, i) => {
                const itemData = cesta[nombre];
                const cantidad = itemData.cantidad;
                const cantidadTexto = cantidad > 0 ? Number(cantidad.toFixed(2)) : ""; 
                
                // Convertir el Set de recetas a un array para pintarlo
                const etiquetasRecetas = Array.from(itemData.fuentes).map(fuente => 
                    `<span class="inline-block bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full mr-1 mb-1 border border-blue-200">${fuente}</span>`
                ).join("");

                const html = `
                <div class="p-4 flex items-start hover:bg-blue-50 transition group">
                    <input type="checkbox" id="item-${i}" class="w-5 h-5 mt-1 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer flex-shrink-0">
                    <div class="ml-3 flex-1">
                        <label for="item-${i}" class="cursor-pointer select-none block">
                            <span class="font-bold text-blue-600 text-lg">${cantidadTexto}</span> 
                            <span class="nombre-item text-gray-700 font-medium text-lg capitalize">${nombre}</span>
                        </label>
                        <div class="mt-1 flex flex-wrap">
                            <span class="text-xs text-gray-400 mr-2 py-0.5">Para:</span>
                            ${etiquetasRecetas}
                        </div>
                    </div>
                </div>`;
                contenedor.innerHTML += html;
            });

            // Platos sin receta
            if (extras.size > 0) {
                const divSeparador = `<div class="bg-yellow-50 p-3 text-xs font-bold text-yellow-700 uppercase tracking-wide border-t border-yellow-200">Platos sin receta detallada</div>`;
                contenedor.innerHTML += divSeparador;
                
                let j = 1000;
                extras.forEach(extra => {
                    const html = `
                    <div class="p-4 flex items-center hover:bg-yellow-100 transition">
                        <input type="checkbox" id="item-${j}" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500 border-gray-300 cursor-pointer">
                        <label for="item-${j}" class="ml-3 text-gray-700 cursor-pointer flex-1 select-none font-medium">
                            ${extra}
                        </label>
                    </div>`;
                    contenedor.innerHTML += html;
                    j++;
                });
            }
        }

        // Utilidades para copiar/compartir
        function obtenerTextoPlano() {
            let texto = "ðŸ›’ *LISTA DE LA COMPRA* \n\n";
            // No podemos usar querySelector simple porque ahora la estructura es compleja.
            // Reconstruimos desde los datos visuales bÃ¡sicos o mejor, iterarÃ­amos el objeto data, 
            // pero para hacerlo rÃ¡pido scrapeamos el DOM generado.
            
            const filas = document.querySelectorAll('#lista-items > div.p-4');
            filas.forEach(fila => {
                const label = fila.querySelector('label').innerText.replace(/\n/g, ' ');
                // Intentamos coger las recetas tambiÃ©n para el texto plano
                const recetas = Array.from(fila.querySelectorAll('.bg-blue-100')).map(span => span.innerText).join(', ');
                
                texto += `â˜ ${label}`;
                if(recetas) texto += ` (${recetas})`;
                texto += "\n";
            });
            return texto;
        }

        function copiarTexto() {
            const texto = obtenerTextoPlano();
            navigator.clipboard.writeText(texto).then(() => alert("Â¡Lista copiada!"));
        }

        function compartirWhatsapp() {
            const texto = obtenerTextoPlano();
            const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

    </script>
</body>
</html>