<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de la Compra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Efecto tachado al marcar el checkbox */
        input:checked + label {
            text-decoration: line-through;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-20">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-4xl mx-auto px-4 py-8 mt-20">
        
        <h1 class="text-3xl font-bold text-slate-800 mb-6 flex items-center gap-3">
            ðŸ›’ Lista de la Compra Inteligente
        </h1>

        <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 mb-8">
            <label class="block text-sm font-bold text-gray-700 mb-2">Â¿QuÃ© semana quieres comprar?</label>
            <div class="flex flex-col md:flex-row gap-4">
                <select id="selector-semana" class="flex-1 p-3 border rounded-xl bg-gray-50 text-lg outline-none focus:ring-2 focus:ring-blue-500">
                    </select>
                <button onclick="generarLista()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                    âœ¨ Generar Lista
                </button>
            </div>
        </div>

        <div id="contenedor-lista" class="hidden">
            
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-700">Ingredientes necesarios:</h2>
                <div class="flex gap-2">
                    <button onclick="copiarTexto()" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition">ðŸ“‹ Copiar</button>
                    <button onclick="compartirWhatsapp()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition">ðŸ’¬ WhatsApp</button>
                </div>
            </div>

            <div id="lista-items" class="bg-white rounded-2xl shadow-lg border border-slate-200 divide-y divide-gray-100 overflow-hidden">
                </div>
            
            <p class="text-xs text-gray-400 mt-4 text-center">
                Nota: El sistema suma cantidades si el nombre del ingrediente es idÃ©ntico.
            </p>
        </div>

    </div>

    <script src="navbar.js"></script>
    <script src="menus.js"></script>
    <script src="recetas.js"></script>

    <script>
        // 1. Cargar el selector de semanas al iniciar
        window.onload = function() {
            const selector = document.getElementById('selector-semana');
            if (typeof coleccionMenus !== 'undefined') {
                coleccionMenus.forEach((menu, index) => {
                    const opt = document.createElement('option');
                    opt.value = index; // Usamos el Ã­ndice del array
                    opt.text = menu.nombre;
                    selector.appendChild(opt);
                });
            }
        };

        // 2. FUNCIÃ“N PRINCIPAL: GENERAR LISTA
        function generarLista() {
            const indexSemana = document.getElementById('selector-semana').value;
            const menuSeleccionado = coleccionMenus[indexSemana];
            
            // Objeto para acumular ingredientes: { "tomates cherry": 6, "cebolla": 1 ... }
            const cestaCompra = {};
            const itemsSinReceta = new Set(); // Para platos que no estÃ¡n en recetas.js

            // Recorremos los 7 dÃ­as
            menuSeleccionado.semana.forEach(dia => {
                // Recorremos las 4 comidas de cada dÃ­a
                ['segundoDesayuno', 'almuerzo', 'merienda', 'cena'].forEach(momento => {
                    const platos = dia.comidas[momento];
                    
                    if (platos && Array.isArray(platos)) {
                        platos.forEach(nombrePlato => {
                            procesarPlato(nombrePlato, cestaCompra, itemsSinReceta);
                        });
                    }
                });
            });

            renderizarLista(cestaCompra, itemsSinReceta);
        }

        function procesarPlato(nombrePlato, cesta, listaExtra) {
            // 1. Buscar si el plato existe en recetas.js
            // Usamos bÃºsqueda flexible (ignoramos mayÃºsculas/minÃºsculas)
            const receta = listaRecetas.find(r => r.titulo.toLowerCase().trim() === nombrePlato.toLowerCase().trim());

            if (receta) {
                // Si encontramos receta, procesamos sus ingredientes
                receta.ingredientes.forEach(lineaIngrediente => {
                    parsearYSumar(lineaIngrediente, cesta);
                });
            } else {
                // Si no hay receta, aÃ±adimos el nombre del plato como "cosa a comprar"
                // (Por ejemplo: "Bocadillo de jamÃ³n" si no tienes receta de eso)
                // OJO: Si prefieres ignorar los platos sin receta, comenta la siguiente lÃ­nea
                listaExtra.add(`[Plato Completo] ${nombrePlato}`);
            }
        }

        function parsearYSumar(textoIngrediente, cesta) {
            // Limpieza bÃ¡sica
            let texto = textoIngrediente.trim();

            // EXPRESIÃ“N REGULAR MÃGICA:
            // Busca un nÃºmero al principio (puede tener decimales o ser fracciÃ³n 1/2)
            // Grupo 1: El nÃºmero (ej: "1.5", "100", "1/2")
            // Grupo 2: El resto del texto (ej: "kg de patatas")
            const regex = /^([\d\.,\/]+)\s*(.*)/;
            const match = texto.match(regex);

            if (match) {
                let cantidad = match[1];
                let nombreItem = match[2].toLowerCase(); // Normalizamos a minÃºsculas

                // Convertir fracciones o comas a nÃºmeros reales
                let cantidadNum = convertirANumero(cantidad);

                // Normalizar nombres comunes para que sumen bien
                // Ej: "gramos de pollo" -> "gr. de pollo"
                nombreItem = normalizarNombre(nombreItem);

                if (cesta[nombreItem]) {
                    cesta[nombreItem] += cantidadNum;
                } else {
                    cesta[nombreItem] = cantidadNum;
                }
            } else {
                // Si no empieza por nÃºmero (ej: "Sal", "Aceite"), lo guardamos con cantidad 0
                // para listar pero no sumar.
                let itemLimpio = texto.toLowerCase();
                if (!cesta[itemLimpio]) cesta[itemLimpio] = 0; 
            }
        }

        function convertirANumero(str) {
            str = str.replace(',', '.'); // Cambiar coma por punto
            if (str.includes('/')) {
                const partes = str.split('/');
                return parseFloat(partes[0]) / parseFloat(partes[1]);
            }
            return parseFloat(str);
        }

        function normalizarNombre(nombre) {
            // PequeÃ±os arreglos para agrupar mejor
            nombre = nombre.replace(/^gramos\s/i, 'gr. ');
            nombre = nombre.replace(/^g\s/i, 'gr. ');
            nombre = nombre.replace(/^ml\s/i, 'ml. ');
            // Quitar "de " al principio si sobra (ej: "100 gr de arroz" -> "100 gr arroz")
            // nombre = nombre.replace(/^de\s/i, ''); 
            return nombre;
        }

        // 3. PINTAR RESULTADOS
        function renderizarLista(cesta, extras) {
            const contenedor = document.getElementById('lista-items');
            contenedor.innerHTML = "";
            document.getElementById('contenedor-lista').classList.remove('hidden');

            // Convertir objeto a array y ordenar alfabÃ©ticamente
            const itemsOrdenados = Object.keys(cesta).sort();

            // Primero los ingredientes calculados
            itemsOrdenados.forEach((nombre, i) => {
                const cantidad = cesta[nombre];
                // Si la cantidad es 0 (ej: Sal), no ponemos nÃºmero. Si tiene decimales, redondeamos a 2.
                const cantidadTexto = cantidad > 0 ? Number(cantidad.toFixed(2)) : ""; 
                
                const html = `
                <div class="p-4 flex items-center hover:bg-blue-50 transition group">
                    <input type="checkbox" id="item-${i}" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 border-gray-300 cursor-pointer">
                    <label for="item-${i}" class="ml-3 text-gray-700 cursor-pointer flex-1 select-none">
                        <span class="font-bold text-blue-600">${cantidadTexto}</span> ${nombre}
                    </label>
                </div>`;
                contenedor.innerHTML += html;
            });

            // Luego los platos sin receta (si los hay)
            if (extras.size > 0) {
                const divSeparador = `<div class="bg-yellow-50 p-3 text-xs font-bold text-yellow-700 uppercase tracking-wide">Platos sin receta detallada (Revisar)</div>`;
                contenedor.innerHTML += divSeparador;
                
                let j = 1000;
                extras.forEach(extra => {
                    const html = `
                    <div class="p-4 flex items-center hover:bg-yellow-100 transition">
                        <input type="checkbox" id="item-${j}" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500 border-gray-300 cursor-pointer">
                        <label for="item-${j}" class="ml-3 text-gray-700 cursor-pointer flex-1 select-none">
                            ${extra}
                        </label>
                    </div>`;
                    contenedor.innerHTML += html;
                    j++;
                });
            }
        }

        // Funciones de utilidad
        function obtenerTextoPlano() {
            let texto = "ðŸ›’ *LISTA DE LA COMPRA* \n\n";
            const items = document.querySelectorAll('#lista-items label');
            items.forEach(item => {
                texto += "â˜ " + item.innerText + "\n";
            });
            return texto;
        }

        function copiarTexto() {
            const texto = obtenerTextoPlano();
            navigator.clipboard.writeText(texto).then(() => alert("Â¡Lista copiada al portapapeles!"));
        }

        function compartirWhatsapp() {
            const texto = obtenerTextoPlano();
            const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

    </script>
</body>
</html>