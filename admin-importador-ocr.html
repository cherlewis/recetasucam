<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Esc√°ner Visual de Men√∫s</title>
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilos para los sliders */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px; width: 16px;
            border-radius: 50%; background: #3b82f6;
            margin-top: -6px; cursor: pointer;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #cbd5e1;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen pb-20 transition-colors duration-300">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-7xl mx-auto px-4 py-8 mt-20">
        
        <h1 class="text-3xl font-bold mb-2 flex items-center gap-2 text-slate-800 dark:text-white">
            üéØ Esc√°ner Visual de Precisi√≥n
        </h1>
        <p class="text-slate-500 mb-6">Ajusta la rejilla roja sobre el texto y extrae los datos con precisi√≥n quir√∫rgica.</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1 space-y-6">
                
                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <label class="block text-sm font-bold mb-2 text-blue-600">1. Sube la Imagen (Ma√±ana o Tarde)</label>
                    <input type="file" id="input-img" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>

                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-700 opacity-50 pointer-events-none transition" id="panel-calibracion">
                    <div class="flex justify-between items-center mb-4">
                        <label class="block text-sm font-bold text-orange-500">2. Calibrar Rejilla</label>
                        <span class="text-[10px] bg-orange-100 text-orange-800 px-2 py-1 rounded">7 Columnas x 2 Filas</span>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span>Posici√≥n X (Horizontal)</span> <span id="val-x">0</span></div>
                            <input type="range" id="range-x" min="0" max="100" value="0" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span>Posici√≥n Y (Vertical)</span> <span id="val-y">0</span></div>
                            <input type="range" id="range-y" min="0" max="100" value="0" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span>Ancho Total</span> <span id="val-w">100</span></div>
                            <input type="range" id="range-w" min="10" max="100" value="100" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1"><span>Alto Total</span> <span id="val-h">100</span></div>
                            <input type="range" id="range-h" min="10" max="100" value="100" class="w-full">
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-slate-800 p-5 rounded-xl shadow border border-slate-200 dark:border-slate-700 opacity-50 pointer-events-none transition" id="panel-accion">
                    <label class="block text-sm font-bold mb-3 text-green-600">3. ¬øQu√© est√°s escaneando?</label>
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <button onclick="escanear('manana')" class="bg-orange-100 hover:bg-orange-200 text-orange-700 py-2 rounded-lg text-xs font-bold transition">
                            ‚òÄÔ∏è Ma√±ana (Des/Alm)
                        </button>
                        <button onclick="escanear('tarde')" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 py-2 rounded-lg text-xs font-bold transition">
                            üåô Tarde (Mer/Cen)
                        </button>
                    </div>
                    
                    <div id="progreso-box" class="hidden">
                         <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                            <div id="barra-progreso" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="texto-estado" class="text-[10px] text-center text-gray-500">Procesando...</p>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-2 bg-gray-900 rounded-xl overflow-hidden shadow-2xl relative flex items-center justify-center min-h-[400px]">
                <p id="placeholder-text" class="text-gray-500 font-bold">Sube una imagen para empezar</p>
                <canvas id="canvas-editor" class="max-w-full max-h-[80vh]"></canvas>
            </div>

        </div>

        <div class="mt-8 bg-slate-900 text-green-400 p-6 rounded-xl shadow-lg border border-slate-700 relative">
            <h3 class="text-white text-sm font-bold mb-2">üì¶ Resultado Acumulado (JSON)</h3>
            <textarea id="resultado-json" readonly class="w-full h-48 bg-transparent border-none outline-none font-mono text-xs resize-none"></textarea>
            <button onclick="copiarCodigo()" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-xs font-bold transition border border-white/20 backdrop-blur">üìã Copiar</button>
            
            <div class="flex justify-end mt-2">
                <button onclick="reiniciarJSON()" class="text-xs text-red-400 hover:underline">üóëÔ∏è Reiniciar Datos</button>
            </div>
        </div>

    </div>

    <script src="navbar.js"></script>

    <script>
        // VARIABLES DE ESTADO
        let imgObj = new Image();
        let canvas = document.getElementById('canvas-editor');
        let ctx = canvas.getContext('2d');
        let grid = { x: 10, y: 10, w: 80, h: 80 }; // Porcentajes
        
        // Estructura de datos final
        let datosFinales = {
            nombre: "Men√∫ Nuevo",
            semana: Array(7).fill(null).map((_, i) => ({
                dia: ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][i],
                comidas: { segundoDesayuno: [], almuerzo: [], merienda: [], cena: [] }
            }))
        };

        // 1. CARGA DE IMAGEN
        document.getElementById('input-img').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                imgObj.onload = () => {
                    document.getElementById('placeholder-text').classList.add('hidden');
                    // Activar paneles
                    document.getElementById('panel-calibracion').classList.remove('opacity-50', 'pointer-events-none');
                    document.getElementById('panel-accion').classList.remove('opacity-50', 'pointer-events-none');
                    
                    ajustarCanvas();
                    dibujar();
                }
                imgObj.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // 2. SISTEMA DE DIBUJADO (Rejilla sobre imagen)
        function ajustarCanvas() {
            // Ajustar tama√±o del canvas a la imagen real
            canvas.width = imgObj.width;
            canvas.height = imgObj.height;
        }

        function dibujar() {
            if (!imgObj.src) return;

            // Limpiar
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Dibujar Imagen
            ctx.drawImage(imgObj, 0, 0);

            // 2. Calcular coordenadas reales basadas en porcentajes de los sliders
            const gx = (grid.x / 100) * canvas.width;
            const gy = (grid.y / 100) * canvas.height;
            const gw = (grid.w / 100) * canvas.width;
            const gh = (grid.h / 100) * canvas.height;

            // 3. Dibujar Rejilla (7 columnas, 2 filas)
            ctx.beginPath();
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3; // L√≠nea gruesa para verla bien
            
            // Caja exterior
            ctx.strokeRect(gx, gy, gw, gh);

            // L√≠neas verticales (Separadores de d√≠as)
            const colW = gw / 7;
            for(let i=1; i<7; i++) {
                ctx.moveTo(gx + (colW * i), gy);
                ctx.lineTo(gx + (colW * i), gy + gh);
            }

            // L√≠nea horizontal (Separador comida 1 y 2)
            const rowH = gh / 2;
            ctx.moveTo(gx, gy + rowH);
            ctx.lineTo(gx + gw, gy + rowH);

            ctx.stroke();

            // Sombra semitransparente fuera de la selecci√≥n para resaltar
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            // Top
            ctx.fillRect(0, 0, canvas.width, gy);
            // Bottom
            ctx.fillRect(0, gy + gh, canvas.width, canvas.height - (gy + gh));
            // Left
            ctx.fillRect(0, gy, gx, gh);
            // Right
            ctx.fillRect(gx + gw, gy, canvas.width - (gx + gw), gh);
        }

        // 3. EVENTOS DE SLIDERS
        function actualizarGrid() {
            grid.x = parseInt(document.getElementById('range-x').value);
            grid.y = parseInt(document.getElementById('range-y').value);
            grid.w = parseInt(document.getElementById('range-w').value);
            grid.h = parseInt(document.getElementById('range-h').value);

            // Actualizar textos
            document.getElementById('val-x').innerText = grid.x + '%';
            document.getElementById('val-y').innerText = grid.y + '%';
            document.getElementById('val-w').innerText = grid.w + '%';
            document.getElementById('val-h').innerText = grid.h + '%';

            dibujar();
        }

        ['range-x', 'range-y', 'range-w', 'range-h'].forEach(id => {
            document.getElementById(id).addEventListener('input', actualizarGrid);
        });


        // 4. L√ìGICA DE ESCANEO (Recorta y lee)
        async function escanear(modo) {
            // modo: 'manana' (fila 1=segundoDesayuno, fila 2=almuerzo)
            // modo: 'tarde' (fila 1=merienda, fila 2=cena)
            
            const boxProgreso = document.getElementById('progreso-box');
            const txtEstado = document.getElementById('texto-estado');
            const barra = document.getElementById('barra-progreso');
            
            boxProgreso.classList.remove('hidden');
            
            const gx = (grid.x / 100) * canvas.width;
            const gy = (grid.y / 100) * canvas.height;
            const gw = (grid.w / 100) * canvas.width;
            const gh = (grid.h / 100) * canvas.height;
            
            const colW = gw / 7;
            const rowH = gh / 2;

            const tipos = modo === 'manana' 
                ? ['segundoDesayuno', 'almuerzo'] 
                : ['merienda', 'cena'];

            try {
                // Iterar 7 d√≠as
                for(let i=0; i<7; i++) {
                    const diaX = gx + (colW * i);

                    // Fila Arriba
                    txtEstado.innerText = `D√≠a ${i+1}/7 - Fila 1...`;
                    barra.style.width = `${((i*2)+1)/14 * 100}%`;
                    const txt1 = await leerRecorte(diaX, gy, colW, rowH);
                    limpiarYGuardar(i, tipos[0], txt1);

                    // Fila Abajo
                    txtEstado.innerText = `D√≠a ${i+1}/7 - Fila 2...`;
                    barra.style.width = `${((i*2)+2)/14 * 100}%`;
                    const txt2 = await leerRecorte(diaX, gy + rowH, colW, rowH);
                    limpiarYGuardar(i, tipos[1], txt2);
                }

                actualizarJSONVisual();
                txtEstado.innerText = "‚úÖ Completado";
                setTimeout(() => boxProgreso.classList.add('hidden'), 2000);

            } catch (err) {
                alert("Error: " + err);
            }
        }

        async function leerRecorte(x, y, w, h) {
            // Crear un canvas temporal peque√±o
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = w;
            tempCanvas.height = h;
            const tCtx = tempCanvas.getContext('2d');
            
            // Dibujar solo el recorte
            tCtx.drawImage(imgObj, x, y, w, h, 0, 0, w, h);
            
            const dataUrl = tempCanvas.toDataURL('image/jpeg');
            const { data: { text } } = await Tesseract.recognize(dataUrl, 'spa');
            return text;
        }

        function limpiarYGuardar(diaIndex, tipo, texto) {
            let lineas = texto.split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 3)
                .filter(l => !l.toLowerCase().includes('ver comentario'));
            
            // Capitalizar
            lineas = lineas.map(l => l.charAt(0).toUpperCase() + l.slice(1).toLowerCase());
            
            if(lineas.length === 0) lineas = ["-"];
            
            datosFinales.semana[diaIndex].comidas[tipo] = lineas;
        }

        function actualizarJSONVisual() {
            let json = JSON.stringify(datosFinales, null, 4);
            json = json.replace(/"(\w+)":/g, '$1:');
            document.getElementById('resultado-json').value = "// Pega esto en menus.js\n" + json + ",";
        }

        function copiarCodigo() {
            document.getElementById('resultado-json').select();
            document.execCommand('copy');
            alert("Copiado al portapapeles");
        }
        
        function reiniciarJSON() {
            if(confirm("¬øBorrar datos capturados?")) {
                datosFinales = {
                    nombre: "Men√∫ Nuevo",
                    semana: Array(7).fill(null).map((_, i) => ({
                        dia: ["Lunes","Martes","Mi√©rcoles","Jueves","Viernes","S√°bado","Domingo"][i],
                        comidas: { segundoDesayuno: [], almuerzo: [], merienda: [], cena: [] }
                    }))
                };
                actualizarJSONVisual();
            }
        }
    </script>
</body>
</html>