<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importador Grid Inteligente</title>
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen pb-20 transition-colors duration-300">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-6xl mx-auto px-4 py-8 mt-20">
        
        <h1 class="text-3xl font-bold mb-2 flex items-center gap-2 text-slate-800 dark:text-white">
            ðŸ“¸ Importador por Rejilla (Slicing)
        </h1>
        <p class="text-slate-500 mb-8">Sube las dos imÃ¡genes. El sistema las recortarÃ¡ automÃ¡ticamente para leer cada dÃ­a por separado.</p>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="space-y-6">
                
                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <label class="block text-sm font-bold mb-2 text-orange-500">IMAGEN 1: MaÃ±ana (Desayuno + Almuerzo)</label>
                    <input type="file" id="img-manana" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100">
                    <p class="text-[10px] text-gray-400 mt-2">Recorta la imagen ajustada a los bordes negros (Lunes a Domingo).</p>
                </div>

                <div class="bg-white dark:bg-slate-800 p-6 rounded-xl shadow border border-slate-200 dark:border-slate-700">
                    <label class="block text-sm font-bold mb-2 text-indigo-500">IMAGEN 2: Tarde (Merienda + Cena)</label>
                    <input type="file" id="img-tarde" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                </div>

                <button onclick="iniciarProceso()" id="btn-procesar" class="w-full bg-slate-900 dark:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 hover:bg-slate-800 dark:hover:bg-blue-700">
                    ðŸš€ Escanear y Generar MenÃº
                </button>

                <div id="progreso-container" class="hidden">
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-2">
                        <div id="barra-progreso" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="texto-estado" class="text-xs text-center font-mono text-blue-600 animate-pulse">Iniciando...</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="bg-slate-900 text-green-400 p-6 rounded-xl shadow-lg border border-slate-700 relative h-full flex flex-col min-h-[400px]">
                    <label class="block text-sm font-bold mb-2 text-white">Resultado JSON</label>
                    <textarea id="resultado-json" readonly class="w-full flex-1 bg-transparent border-none outline-none font-mono text-xs resize-none" placeholder="El cÃ³digo aparecerÃ¡ aquÃ­..."></textarea>
                    <button onclick="copiarCodigo()" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded text-xs font-bold transition border border-white/20 backdrop-blur">ðŸ“‹ Copiar</button>
                </div>
            </div>
        </div>

        <canvas id="canvas-oculto" class="hidden"></canvas>

    </div>

    <script src="navbar.js"></script>

    <script>
        const diasSemana = ["Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado", "Domingo"];
        let menuFinal = { nombre: "Semana Escaneada", semana: [] };

        // Inicializar estructura vacÃ­a
        diasSemana.forEach(dia => {
            menuFinal.semana.push({
                dia: dia,
                comidas: { segundoDesayuno: [], almuerzo: [], merienda: [], cena: [] }
            });
        });

        async function iniciarProceso() {
            const fileManana = document.getElementById('img-manana').files[0];
            const fileTarde = document.getElementById('img-tarde').files[0];

            if (!fileManana || !fileTarde) return alert("âš ï¸ Por favor, sube ambas imÃ¡genes.");

            document.getElementById('btn-procesar').disabled = true;
            document.getElementById('btn-procesar').classList.add('opacity-50');
            document.getElementById('progreso-container').classList.remove('hidden');

            try {
                // 1. PROCESAR MAÃ‘ANA (Desayuno y Almuerzo)
                actualizarEstado("Escaneando MaÃ±anas...", 10);
                await procesarImagenGrid(fileManana, ['segundoDesayuno', 'almuerzo']);

                // 2. PROCESAR TARDE (Merienda y Cena)
                actualizarEstado("Escaneando Tardes...", 60);
                await procesarImagenGrid(fileTarde, ['merienda', 'cena']);

                // 3. FINALIZAR
                actualizarEstado("Generando cÃ³digo...", 100);
                mostrarResultado();

            } catch (error) {
                console.error(error);
                alert("Hubo un error: " + error.message);
            } finally {
                document.getElementById('btn-procesar').disabled = false;
                document.getElementById('btn-procesar').classList.remove('opacity-50');
            }
        }

        function actualizarEstado(texto, porcentaje) {
            document.getElementById('texto-estado').innerText = texto;
            document.getElementById('barra-progreso').style.width = porcentaje + "%";
        }

        async function procesarImagenGrid(file, tiposComida) {
            // tiposComida serÃ¡ ['segundoDesayuno', 'almuerzo'] o ['merienda', 'cena']
            
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.getElementById('canvas-oculto');
                    const ctx = canvas.getContext('2d');

                    // Calculamos el ancho de cada columna (DÃ­a)
                    // Asumimos que la imagen tiene los 7 dÃ­as (Lunes a Domingo)
                    const anchoColumna = img.width / 7;
                    const altoFila = img.height / 2; // Asumimos que la fila de arriba es comida 1 y la de abajo comida 2

                    // Iterar por los 7 dÃ­as
                    for (let i = 0; i < 7; i++) {
                        // --- FILA DE ARRIBA (Ej: Desayuno o Merienda) ---
                        const textoArriba = await recortarYLeer(img, ctx, canvas, i * anchoColumna, 0, anchoColumna, altoFila);
                        limpiarYGuardar(i, tiposComida[0], textoArriba);

                        // --- FILA DE ABAJO (Ej: Almuerzo o Cena) ---
                        const textoAbajo = await recortarYLeer(img, ctx, canvas, i * anchoColumna, altoFila, anchoColumna, altoFila);
                        limpiarYGuardar(i, tiposComida[1], textoAbajo);
                    }
                    resolve();
                };
                img.src = URL.createObjectURL(file);
            });
        }

        async function recortarYLeer(img, ctx, canvas, x, y, w, h) {
            // Configurar canvas al tamaÃ±o del recorte
            canvas.width = w;
            canvas.height = h;
            
            // Dibujar solo el trocito
            ctx.drawImage(img, x, y, w, h, 0, 0, w, h);
            
            // Convertir a imagen para Tesseract
            const dataUrl = canvas.toDataURL('image/jpeg');

            // Ejecutar OCR en ese trocito
            const { data: { text } } = await Tesseract.recognize(dataUrl, 'spa');
            return text;
        }

        function limpiarYGuardar(diaIndex, tipoComida, textoBruto) {
            // 1. Limpieza bÃ¡sica
            let lineas = textoBruto.split('\n')
                .map(l => l.trim())
                .filter(l => l.length > 3) // Quitar lÃ­neas muy cortas
                .filter(l => !l.toLowerCase().includes('ver comentario')) // Quitar botones web
                .filter(l => !l.toLowerCase().includes('pieza de fruta')) // Quitar genÃ©ricos repetitivos si quieres
                .filter(l => !diasSemana.some(d => l.toLowerCase().includes(d.toLowerCase()))); // Quitar cabecera "LUNES"

            // 2. Capitalizar
            lineas = lineas.map(l => l.charAt(0).toUpperCase() + l.slice(1).toLowerCase());

            // 3. Guardar en el objeto global
            if (lineas.length === 0) lineas = ["-"];
            menuFinal.semana[diaIndex].comidas[tipoComida] = lineas;
        }

        function mostrarResultado() {
            let jsonString = JSON.stringify(menuFinal, null, 4);
            // Quitar comillas de las claves
            jsonString = jsonString.replace(/"(\w+)":/g, '$1:');
            
            document.getElementById('resultado-json').value = 
                "// Pega esto en menus.js dentro de coleccionMenus.push(...)\n" +
                jsonString + ",";
        }

        function copiarCodigo() {
            const codigo = document.getElementById('resultado-json');
            codigo.select();
            document.execCommand('copy');
            alert("Â¡Copiado! Ahora pÃ©galo en menus.js.");
        }
    </script>
</body>
</html>