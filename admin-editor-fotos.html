<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Fotos Inteligente</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen pb-20 transition-colors duration-300">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-7xl mx-auto px-4 py-8 mt-20">
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white flex items-center gap-2">üì∏ Organizador de Fotos</h1>
                <p class="text-slate-500 dark:text-slate-400">Renombra y organiza tus fotos autom√°ticamente.</p>
            </div>
            <button onclick="descargarPack()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg flex items-center gap-2 w-full md:w-auto justify-center disabled:opacity-50 disabled:cursor-not-allowed" id="btn-descargar">
                üì¶ Descargar Pack (.ZIP)
            </button>
        </div>
        
        <div id="drop-zone" class="border-4 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl p-12 text-center bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-700 transition cursor-pointer mb-8 group">
            <p class="text-4xl mb-2 group-hover:scale-110 transition-transform">üìÇ</p>
            <p class="text-xl font-bold text-slate-700 dark:text-slate-200">Arrastra aqu√≠ tus fotos</p>
            <p class="text-sm text-slate-400 dark:text-slate-500">O haz clic para seleccionar</p>
            <input type="file" id="file-input" multiple accept="image/*" class="hidden">
        </div>

        <div id="grid-fotos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>

    </div>

    <script src="navbar.js"></script>
    <script src="recetas.js"></script>

    <script>
        let archivosEnMemoria = []; 

        // INICIALIZACI√ìN
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-400', 'bg-blue-50', 'dark:bg-slate-700', 'dark:border-blue-500');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-slate-700', 'dark:border-blue-500');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-400', 'bg-blue-50', 'dark:bg-slate-700', 'dark:border-blue-500');
            procesarArchivos(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            procesarArchivos(e.target.files);
        });

        function procesarArchivos(files) {
            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;

                const idUnico = Date.now() + Math.random(); 
                
                archivosEnMemoria.push({
                    idTemp: idUnico,
                    file: file,
                    idRecetaAsignada: "" 
                });

                pintarTarjetaFoto(file, idUnico);
            });
        }

        function pintarTarjetaFoto(file, idTemp) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                
                // TARJETA CON ESTILOS DARK MODE
                div.className = "bg-white dark:bg-slate-800 p-4 rounded-xl shadow border border-slate-200 dark:border-slate-700 flex flex-col gap-3 relative group transition-colors";
                div.id = `card-${idTemp}`;

                let opcionesRecetas = `<option value="">-- Selecciona Receta --</option>`;
                if (typeof listaRecetas !== 'undefined') {
                    const recetasOrd = [...listaRecetas].sort((a,b) => a.titulo.localeCompare(b.titulo));
                    recetasOrd.forEach(r => {
                        opcionesRecetas += `<option value="${r.id}">${r.titulo} (ID: ${r.id})</option>`;
                    });
                }

                div.innerHTML = `
                    <div class="relative h-48 rounded-lg overflow-hidden bg-gray-100 dark:bg-slate-900">
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <button onclick="eliminarFoto(${idTemp})" class="absolute top-2 right-2 bg-red-500 text-white p-1 rounded-full hover:bg-red-600 shadow opacity-0 group-hover:opacity-100 transition">‚úï</button>
                    </div>
                    
                    <div>
                        <p class="text-xs text-gray-400 dark:text-gray-500 truncate mb-1">${file.name}</p>
                        <select onchange="asignarReceta(${idTemp}, this.value)" 
                                class="w-full p-2 border rounded text-sm font-semibold outline-none transition-colors
                                       bg-slate-50 dark:bg-slate-700 
                                       text-slate-800 dark:text-white
                                       border-slate-200 dark:border-slate-600
                                       focus:ring-2 focus:ring-blue-500">
                            ${opcionesRecetas}
                        </select>
                    </div>
                    <div id="preview-nombre-${idTemp}" class="text-xs font-mono text-center text-blue-600 dark:text-blue-400 h-6 flex items-center justify-center"></div>
                `;

                document.getElementById('grid-fotos').appendChild(div);
            };
            reader.readAsDataURL(file);
        }

        function asignarReceta(idTemp, idReceta) {
            const fotoObj = archivosEnMemoria.find(f => f.idTemp === idTemp);
            if (fotoObj) {
                fotoObj.idRecetaAsignada = idReceta;
                actualizarNombresPreview();
            }
        }

        function eliminarFoto(idTemp) {
            archivosEnMemoria = archivosEnMemoria.filter(f => f.idTemp !== idTemp);
            document.getElementById(`card-${idTemp}`).remove();
            actualizarNombresPreview();
        }

        function actualizarNombresPreview() {
            const contadorRecetas = {}; 

            archivosEnMemoria.forEach(foto => {
                const idReceta = foto.idRecetaAsignada;
                const divPreview = document.getElementById(`preview-nombre-${foto.idTemp}`);
                
                if (!idReceta) {
                    divPreview.innerText = "";
                    divPreview.className = "text-xs font-mono text-center text-blue-600 dark:text-blue-400 h-6 flex items-center justify-center";
                    return;
                }

                if (!contadorRecetas[idReceta]) contadorRecetas[idReceta] = 0;
                contadorRecetas[idReceta]++;

                let nombreFinal = "";
                if (contadorRecetas[idReceta] === 1) {
                    nombreFinal = `${idReceta}.jpg`; 
                } else {
                    nombreFinal = `${idReceta}-${contadorRecetas[idReceta] - 1}.jpg`; 
                }

                divPreview.innerText = "Renombrado a: " + nombreFinal;
                // Estilo "Badge" verde adaptado
                divPreview.className = "text-xs font-mono text-center h-6 flex items-center justify-center bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 rounded w-full";
            });
        }

        async function descargarPack() {
            const zip = new JSZip();
            let hayArchivos = false;
            const contadorRecetas = {};

            archivosEnMemoria.forEach(foto => {
                if (!foto.idRecetaAsignada) return; 

                hayArchivos = true;
                const idReceta = foto.idRecetaAsignada;
                
                if (!contadorRecetas[idReceta]) contadorRecetas[idReceta] = 0;
                contadorRecetas[idReceta]++;

                let nombreFinal = "";
                if (contadorRecetas[idReceta] === 1) {
                    nombreFinal = `${idReceta}.jpg`;
                } else {
                    nombreFinal = `${idReceta}-${contadorRecetas[idReceta] - 1}.jpg`;
                }

                zip.file(nombreFinal, foto.file);
            });

            if (!hayArchivos) {
                alert("‚ö†Ô∏è Primero asigna alguna foto a una receta.");
                return;
            }

            const content = await zip.generateAsync({type:"blob"});
            saveAs(content, "imagenes_nuevas.zip");
            alert("‚úÖ Pack descargado.\n\n1. Descomprime el ZIP.\n2. Mueve las fotos a tu carpeta 'imagenes'.\n3. Sube a Netlify.");
        }
    </script>
</body>
</html>