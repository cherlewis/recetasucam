<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Men√∫s</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>body { font-family: 'Inter', sans-serif; }</style>
</head>
<body class="bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-100 min-h-screen pb-20 transition-colors duration-300">

    <div id="mi-menu-reutilizable"></div>

    <div class="max-w-7xl mx-auto px-4 py-8 mt-20">
        
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 dark:text-white">üìù Editor de Men√∫s</h1>
                <p class="text-slate-500 dark:text-slate-400">Modifica los platos y objetivos de la semana.</p>
            </div>
            <button onclick="descargarArchivo()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg flex items-center gap-2 w-full md:w-auto justify-center">
                üíæ Guardar cambios (Descargar)
            </button>
        </div>
        
        <div class="mb-8 bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 transition-colors">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Selecciona la Semana a Editar:</label>
            <select id="selector-semana" onchange="cargarSemana()" class="w-full p-3 border rounded-lg bg-gray-50 dark:bg-slate-700 text-slate-800 dark:text-white border-gray-200 dark:border-slate-600 outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
            </select>
        </div>

        <div class="mb-8 bg-blue-50 dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-blue-100 dark:border-slate-700 transition-colors relative">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">üéØ</span>
                <label class="block text-sm font-bold text-blue-800 dark:text-blue-300 uppercase">Objetivos de esta semana</label>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">Escribe cada objetivo en una l√≠nea nueva. Se mostrar√°n como una lista en el Plan Semanal.</p>
            
            <textarea 
                id="input-objetivos" 
                oninput="actualizarObjetivos(this.value)"
                class="w-full p-4 border rounded-xl min-h-[100px] outline-none transition-colors
                       bg-white dark:bg-slate-700 
                       text-slate-800 dark:text-white
                       border-blue-200 dark:border-slate-600
                       focus:ring-2 focus:ring-blue-400 placeholder:text-slate-300 dark:placeholder:text-slate-500"
                placeholder="Ej: Beber 2L de agua&#10;Caminar 30 min&#10;Dormir 8 horas..."
            ></textarea>
        </div>
        <div id="contenedor-dias" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            </div>

    </div>

    <script src="navbar.js"></script>
    <script src="menus.js"></script>

    <script>
        // Referencias globales
        let datosGlobales = []; 
        let indiceActual = 0; // Guardamos el √≠ndice globalmente
        
        // Al iniciar
        window.onload = function() {
            if (typeof coleccionMenus !== 'undefined') {
                // Copia profunda para editar sin miedo
                datosGlobales = JSON.parse(JSON.stringify(coleccionMenus));
                inicializarSelector();
                cargarSemana();
            } else {
                document.getElementById('contenedor-dias').innerHTML = '<p class="text-red-500">Error: No se encuentra menus.js</p>';
            }
        };

        function inicializarSelector() {
            const selector = document.getElementById('selector-semana');
            selector.innerHTML = "";
            datosGlobales.forEach((menu, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                opt.text = menu.nombre;
                selector.appendChild(opt);
            });
            // Seleccionar el √∫ltimo por defecto (m√°s c√≥modo)
            if(datosGlobales.length > 0) selector.value = datosGlobales.length - 1;
        }

        function cargarSemana() {
            indiceActual = document.getElementById('selector-semana').value;
            const menuActual = datosGlobales[indiceActual];
            const contenedor = document.getElementById('contenedor-dias');
            
            // 1. CARGAR OBJETIVOS EN EL NUEVO TEXTAREA
            const cajaObjetivos = document.getElementById('input-objetivos');
            if (menuActual.objetivo) {
                // Si es array lo unimos con saltos de linea, si es string lo dejamos tal cual
                if(Array.isArray(menuActual.objetivo)) {
                    cajaObjetivos.value = menuActual.objetivo.join('\n');
                } else {
                    cajaObjetivos.value = menuActual.objetivo;
                }
            } else {
                cajaObjetivos.value = "";
            }

            // 2. CARGAR D√çAS
            contenedor.innerHTML = "";

            menuActual.semana.forEach((diaObj, diaIndex) => {
                const htmlDia = `
                <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow border border-slate-200 dark:border-slate-700 transition-colors">
                    <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 border-b border-slate-100 dark:border-slate-700 pb-2 capitalize">${diaObj.dia}</h3>
                    
                    <div class="space-y-4">
                        ${crearInput(indiceActual, diaIndex, 'segundoDesayuno', 'Segundo Desayuno', diaObj.comidas.segundoDesayuno)}
                        ${crearInput(indiceActual, diaIndex, 'almuerzo', 'Almuerzo', diaObj.comidas.almuerzo)}
                        ${crearInput(indiceActual, diaIndex, 'merienda', 'Merienda', diaObj.comidas.merienda)}
                        ${crearInput(indiceActual, diaIndex, 'cena', 'Cena', diaObj.comidas.cena)}
                    </div>
                </div>
                `;
                contenedor.innerHTML += htmlDia;
            });
        }

        // NUEVA FUNCI√ìN PARA GUARDAR OBJETIVOS
        function actualizarObjetivos(valorTexto) {
            // Convertimos el texto del textarea en un Array separado por l√≠neas
            const listaObjetivos = valorTexto.split('\n').filter(linea => linea.trim() !== "");
            datosGlobales[indiceActual].objetivo = listaObjetivos;
        }

        function crearInput(menuIdx, diaIdx, tipoComida, label, valores) {
            const textoValor = Array.isArray(valores) ? valores.join('\n') : valores;

            // TEXTAREAS ADAPTADOS AL MODO OSCURO
            return `
                <div>
                    <label class="block text-xs font-bold text-gray-400 dark:text-gray-500 uppercase mb-1">${label}</label>
                    <textarea 
                        oninput="actualizarDato(${menuIdx}, ${diaIdx}, '${tipoComida}', this.value)"
                        class="w-full p-2 border rounded text-sm min-h-[80px] outline-none transition-colors
                               bg-slate-50 dark:bg-slate-700 
                               text-slate-800 dark:text-white
                               border-gray-200 dark:border-slate-600
                               focus:bg-white dark:focus:bg-slate-600 focus:ring-2 focus:ring-blue-400"
                        placeholder="Escribe cada plato en una l√≠nea nueva..."
                    >${textoValor}</textarea>
                </div>
            `;
        }

        function actualizarDato(menuIdx, diaIdx, tipoComida, nuevoValor) {
            const arrayPlatos = nuevoValor.split('\n').filter(linea => linea.trim() !== "");
            datosGlobales[menuIdx].semana[diaIdx].comidas[tipoComida] = arrayPlatos;
        }

        function descargarArchivo() {
            const jsonString = JSON.stringify(datosGlobales, null, 4);
            let contenidoJS = "const coleccionMenus = " + jsonString + ";";
            contenidoJS = contenidoJS.replace(/"(\w+)":/g, '$1:');

            const blob = new Blob([contenidoJS], { type: "text/javascript" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = "menus.js";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert("‚úÖ Archivo descargado.\nSustituye el antiguo 'menus.js' con este nuevo.");
        }
    </script>
</body>
</html>